# Gauteng Wellbeing Mapper â€“ Data Pipeline

This repository packages everything required to download encrypted Qualtrics survey responses, decrypt them with the project private key, and export ready-to-analyse CSV tables (plus images) for the Gauteng Wellbeing Mapper study.

## ğŸš€ Quick start

1. Navigate to `pipeline_toolkit/` and copy `.env.example` to `.env`.
2. Fill in the required secrets in `.env`:
   - `QUALTRICS_API_TOKEN`
  - `QUALTRICS_BASE_URL`
  - `QUALTRICS_SURVEY_ID`
  - Optional overrides for `PRIVATE_KEY_PASSWORD` / `PRIVATE_KEY_PATH`
3. Place the RSA private key as `pipeline_toolkit/secrets/private_key.pem` (or point `PRIVATE_KEY_PATH` to your key).
4. From the repository root, run the bundled launcher:

```bash
./run_pipeline.sh
```

The launcher creates a virtual environment, installs dependencies, loads your `.env`, and calls `pipeline_runner.py`. Structured CSVs land in `data/structured/` and participant HTML reports (plus interactive maps) live in `data/reports/`. A JSON summary of the latest execution lives in `pipeline_toolkit/last_run_summary.json`.

## ğŸ“ Directory overview

- `pipeline_toolkit/`
  - `pipeline_runner.py` â€“ orchestrates download â†’ decrypt â†’ structure â†’ report.
  - `requirements.txt` â€“ dependency list used by the launcher.
  - `.env.example` â€“ template for required secrets.
  - `secrets/` â€“ drop `private_key.pem` here (ignored by git).
- `run_pipeline.sh` â€“ one-touch launcher at the repo root (loads `.env`, manages venv/deps, executes the runner).
- `qualtrics_tools/` â€“ Qualtrics API download utilities (`download_qualtrics_data.py`).
- `decryption_tools/` â€“ Automated RSA/AES decryption pipeline.
- `structure_tools/` â€“ Data structuring (`generate_survey_csvs.py`), biweekly compliance analysis (`calculate_biweekly_periods.py`), reporting (`generate_participant_reports.py`), and analytics helpers.
- `data/`
  - `raw/` â€“ Fresh Qualtrics exports.
  - `decrypted/` â€“ Intermediate decrypted CSVs.
  - `structured/` â€“ Final CSVs (`biweekly_survey.csv`, `initial_survey.csv`, `consent.csv`, `location_data.csv`), extracted images, and `processing_report.json`.
  - `reports/` â€“ Timestamped participant HTML reports plus embedded folium map files.
- `validate_survey_data.py` â€“ Optional audit of the structured outputs.

## ğŸ§­ Manual control (run steps individually)

```bash
# 1. Download from Qualtrics
python qualtrics_tools/download_qualtrics_data.py --output ./data/raw --all

# 2. Decrypt the encrypted payloads
PRIVATE_KEY_PASSWORD='â€¢â€¢â€¢' python decryption_tools/automated_decryption_pipeline.py \
  --input ./data/raw --output ./data/decrypted \
  --private-key pipeline_toolkit/secrets/private_key.pem

# 3. Build the analysis tables and extract images
python structure_tools/generate_survey_csvs.py \
  --input ./data/decrypted --output ./data/structured \
  --download-images --report --validate

# 4. Evaluate biweekly participation/compliance
python structure_tools/calculate_biweekly_periods.py \
  --input ./data/structured --output ./data/structured

# 5. Generate participant HTML reports (after structuring completes)
python structure_tools/generate_participant_reports.py \
  --input ./data/structured --output ./data/reports
```

Audit the final CSVs if needed:

```bash
python validate_survey_data.py --input ./data/structured --detailed-report
```

## âœ… Expected outputs

After a successful run you will have:

- `data/structured/biweekly_survey.csv`
- `data/structured/initial_survey.csv`
- `data/structured/consent.csv`
- `data/structured/location_data.csv`
- `data/structured/biweekly_period_summary.csv` & `.md` (per-run compensation tracker)
- `data/structured/biweekly_period_summary_latest.csv` (rolling summary across runs)
- `data/structured/processing_report.json` â€“ summary generated by `generate_survey_csvs.py`
- `data/reports/index.html` â€“ directory listing of per-participant reports
- `data/reports/<timestamp>/<participant>.html` â€“ individual reports with embedded maps
- `pipeline_toolkit/last_run_summary.json` â€“ metadata for the latest execution

## ğŸ” Secrets handling

- `.env` (excluded from git repository) stores the Qualtrics credentials and configuration (`QUALTRICS_API_TOKEN`, `QUALTRICS_BASE_URL`, `QUALTRICS_SURVEY_ID`, and optionally `PRIVATE_KEY_PASSWORD`).
- `pipeline_toolkit/secrets/private_key.pem` (excluded from git repository) houses the RSA private key.

## ğŸ›  Requirements

- Python 3.10+ (tested with 3.12)
- Internet connectivity for Qualtrics downloads
- PIP packages installed automatically via `run_pipeline.sh` (`pandas`, `requests`, `cryptography`, `folium`, `markdown`, `boto3`)

## ğŸ†˜ Troubleshooting

| Symptom | Checks |
| --- | --- |
| Download fails | Ensure `.env` has `QUALTRICS_API_TOKEN`. Verify Qualtrics permissions. |
| Decryption fails | Confirm `PRIVATE_KEY_PASSWORD` and that `private_key.pem` matches incoming data. |
| No CSV output | Confirm `data/decrypted/` contains `*_decrypted_responses.csv`; rerun structuring step. |

For deeper context explore the READMEs inside `pipeline_toolkit/`, `qualtrics_tools/`, `decryption_tools/`, and `structure_tools/`.

## ğŸ“„ License

This project is distributed under the terms of the [GNU General Public License v3.0](https://www.gnu.org/licenses/gpl-3.0.en.html). Â© 2025 John R.B. Palmer.


